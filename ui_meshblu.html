
<!doctype html>
<html>
<head>
  <title>Octoblu Astral Plane</title>
  <link rel="stylesheet" type="text/css" href="dist/jquery.gridster.css">
  <link rel="stylesheet" type="text/css" href="assets/demo.css">

      <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
      <script src="http://cdn.octoblu.com/js/meshblu/latest/meshblu.bundle.js" type="text/javascript"></script>
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
      <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
      <script  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>

      <script src="dist/jquery.gridster.js" type="text/javascript" charset="utf-8"></script>
      <script src="assets/jquery.kontrol.js"></script>

</head>

<body>

    <div class="controls">
        <button class="js-seralize">Load Saved Panel</button>

        <button class="enableDrag">Drag Enable</button>
        <button class="disableDrag">Drag Disable</button>
        <button class="AddDial">Add Dial</button>
        <button class="AddPad">Add XY Pad</button>
        <button class="AddSlider">Add Slider</button>
         <button class="j2-seralize">Save</button>
    </div>

    <div class="gridster">
        <ul>
        </ul>
    </div>




    <script type="text/javascript">


          var gridster;

          // same object than generated with gridster.serialize() method

          var created = [];

          var data = {};

          var ui_data = [];

          var serialization = [];

          var GET = {};
          var query = window.location.search.substring(1).split("&");
          for (var i = 0, max = query.length; i < max; i++)
          {
              if (query[i] === "") // check for trailing & with no param
                  continue;

              var param = query[i].split("=");
              GET[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
          }
          var conn = meshblu.createConnection({
              "uuid": GET.uuid,
              "token": GET.token
            });


 conn.on('ready', function(data){
 console.log('UUID AUTHENTICATED!');
 console.log(data);



// Enable and Disable Dragging

      $('.disableDrag').on('click', function() {
            gridster.disable();

          });

          $('.enableDrag').on('click', function() {
                gridster.enable();
              });

// enable/disable end

$('.AddDial').on('click', function() {

      var className = prompt("Please enter your a name for this Dial");
      var classV = "." + className;

      var html = '<li id="' + className + '"><input type="text" value="75" class="' + className + '"></li>';

      ui_data.push({"className": className, "classV": classV, "type": "dial", "html": html});

      gridster.add_widget(html, 2, 2);
      createUI("dial", classV);
    });

$('.AddPad').on('click', function() {

      var className = prompt("Please enter your a name for this XY Pad");
      var classV = "." + className;

      var html = '<li id="' + className + '" style="min-width: 200px; min-height: 200px;"><fieldset  class="' + className + '" data-width="200" data-height="200"><legend>XY Pad</legend>x : <input name="x" value=27>y : <input name="y" value=80></fieldset></li>';

      ui_data.push({"className": className, "classV": classV, "type": "pad", "html": html});

      gridster.add_widget(html, 2, 2);
      createUI("pad", classV);
    });

$('.AddSlider').on('click', function() {

      var className = prompt("Please enter your a name for this Slider");
      var classV = "." + className;

      var html = '<li id="' + className + '"><div style="margin-top: 40px;" id="slider" class="' + className + '"></div></li>';

      ui_data.push({"className": className, "classV": classV, "type": "slider", "html": html});

      gridster.add_widget(html, 2, 1, function(data){
        console.log("Widget Added: ", data);
      });
      createUI("slider", classV);
    });

    $('.j2-seralize').on('click', function() {
             var s = gridster.serialize();
             serialization = s;



          //    console.log($(".gridster").find(".dial2"));

           console.log("log: ", s);
           console.log("ui data: ", ui_data);

           conn.update({
  "uuid": GET.uuid,
  "widgets": serialization,
  "ui_data": ui_data
}, function(result) {});



            //console.log(gridster.$widgets);
          });
      // sort serialization
      serialization = Gridster.sort_by_row_and_col_asc(serialization);

      $(function(){

        gridster = $(".gridster ul").gridster({
          widget_base_dimensions: [100, 100],
          widget_margins: [5, 5],
          serialize_params: function ($w, wgd) {
            return {
                id: wgd.el[0].id,
                col: wgd.col,
                row: wgd.row,
                size_x: wgd.size_x,
                size_y: wgd.size_y,
                htmlContent: $($w).html()
            };
        }
        }).data('gridster');


        $('.js-seralize').on('click', function() {
          //  gridster.remove_all_widgets();

          conn.whoami({}, function(result) {console.log(result); serialization = result.widgets; ui_data = result.ui_data;
            $.each(serialization, function() {
              if(!(inArray2(this.id, gridster.serialize()))){
                var html = this.id;
                var type;
                var classV;
                  $.each(ui_data, function() {
                          if(this.className == html){
                            html = this.html;
                            type = this.type;
                            classV = this.classV;
                          }
                      });
                console.log("type", type);
                console.log("classv", classV);
                gridster.add_widget(html, this.size_x, this.size_y, this.col, this.row);
                createUI(type, classV);
              }
            });


            });

        });


      });


      function createUI(type, className) {

        console.log(inArray(className, created));

        if(inArray(className, created) == true){
          return;
        }else if(inArray( className, created) == false){

          created.push(className);

                    switch(type) {
              case "dial":
              var $dial = $(className)
                          .dial({
                              'change':function(e){
                                      console.log(className + ": ",e);
                                      var message = {
                                      "devices": "*",
                                      "payload": {
                                      "panelData": {}
                                      }
                                    };
                                      message.payload.panelData[className.substring(1)] = e;
                                      conn.message(message);

                                  }
                              });
                  break;
              case "pad":
              var $pad = $(className)
                          .xy({
                                  displayPrevious:false
                                  , min : -100
                                  , max : 100
                                  , fgColor:"#222222"
                                  , bgColor:"#EEEEEE"
                                  , change : function (value) {
                                      console.log("change " + className + ": ", value);
                                      var message = {
                                      "devices": "*",
                                      "payload": {
                                      "panelData": {}
                                      }
                                    };
                                      message.payload.panelData[className.substring(1)] = value;
                                      conn.message(message);
                                  }
                              })
                          .css({'border':'5px solid #BBB'});

                  break;
              case "slider":
              var $slider = $(className)
                          .slider({
                              'change':function(event,ui){
                                      console.log(className + ": ",ui.value);
                                      var message = {
                                      "devices": "*",
                                      "payload": {
                                      "panelData": {}
                                      }
                                    };
                                      message.payload.panelData[className.substring(1)] = ui.value;
                                      conn.message(message);
                                  }
                              });
                  break;

            }

          }
      }


      function inArray(needle,haystack)
    {
        var count=haystack.length;
        for(var i=0;i<count;i++)
        {
            if(haystack[i]== needle){return true;}
        }
        return false;
    }


          function inArray2(needle,haystack)
        {
            var count=haystack.length;
            for(var i=0;i<count;i++)
            {
                if(haystack[i].htmlContent== needle){return true;}
            }
            return false;
        }


  });


</script>
</body>
</html>
